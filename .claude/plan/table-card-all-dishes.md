# ğŸ“‹ å®æ–½è®¡åˆ’ï¼šæ¡Œä½å¡ç‰‡æ˜¾ç¤ºå…¨éƒ¨èœå“

## éœ€æ±‚åˆ†æ

**åŸå§‹éœ€æ±‚**ï¼šæ¡Œä½å¡ç‰‡åº”æ˜¾ç¤ºæ‰€æœ‰èœå“ï¼ˆå·²ä¸Š+æœªä¸Šï¼‰ï¼Œè¶…å‡ºæ—¶æä¾›"æŸ¥çœ‹è¯¦æƒ…"æ“ä½œï¼Œåˆ†ææ˜¯å¦éœ€è¦æ˜¾ç¤ºèœå“çŠ¶æ€å’Œå•å“ä»·æ ¼ã€‚

**å¢å¼ºåéœ€æ±‚**ï¼š
- å°† TableCard èœå“åˆ—è¡¨ä»"ä»…æœªä¸Šèœ"æ”¹ä¸º"å…¨éƒ¨èœå“"
- å·²ä¸Šèœä¸æœªä¸Šèœéœ€æœ‰è§†è§‰åŒºåˆ†ï¼ˆæœªä¸Šèœä¼˜å…ˆæ˜¾ç¤ºï¼‰
- å¡ç‰‡é¢„è§ˆé™åˆ¶ 3 é¡¹ï¼Œè¶…å‡ºæ—¶æä¾›"æŸ¥çœ‹è¯¦æƒ…"å…¥å£å±•ç¤ºå®Œæ•´åˆ—è¡¨
- å•å“ä»·æ ¼ï¼šå¡ç‰‡ä¸Šä¸æ˜¾ç¤ºï¼ˆç©ºé—´æœ‰é™ä¸”æ€»ä»·å·²å±•ç¤ºï¼‰ï¼Œè¯¦æƒ…å¼¹çª—ä¸­æ˜¾ç¤º
- PC ç«¯å’Œç§»åŠ¨ç«¯å…±ç”¨åŒä¸€ç»„ä»¶ï¼Œäº¤äº’ä¿æŒä¸€è‡´

## ä»»åŠ¡ç±»å‹
- [x] å‰ç«¯
- [x] åç«¯
- [ ] å…¨æ ˆï¼ˆå‰åç«¯è”åŠ¨ä¿®æ”¹ï¼‰

## æŠ€æœ¯æ–¹æ¡ˆ

### è®¾è®¡å†³ç­–ï¼ˆåŒæ¨¡å‹äº¤å‰éªŒè¯ç»“è®ºï¼‰

| å†³ç­–é¡¹ | ç»“è®º | ä¾æ® |
|--------|------|------|
| èœå“çŠ¶æ€åŒºåˆ† | âœ… éœ€è¦ | è¿è¥ä»·å€¼é«˜ï¼Œé¿å…é‡å¤ä¸Šèœï¼Œä¸€ç›®äº†ç„¶æŒæ¡æ¡Œä½è¿›åº¦ |
| å•å“ä»·æ ¼ï¼ˆå¡ç‰‡ï¼‰ | âŒ ä¸æ˜¾ç¤º | ç©ºé—´æœ‰é™ï¼Œæ€»ä»·å·²å±•ç¤ºï¼Œä»·æ ¼å±äºè¯¦æƒ…çº§ä¿¡æ¯ |
| å•å“ä»·æ ¼ï¼ˆè¯¦æƒ…å¼¹çª—ï¼‰ | âœ… æ˜¾ç¤º | è¯¦æƒ…è§†å›¾ç©ºé—´å……è¶³ï¼Œæ–¹ä¾¿æ ¸å¯¹è´¦å• |
| å·²ä¸Šèœè§†è§‰æ ·å¼ | é™ä½é€æ˜åº¦ + åˆ é™¤çº¿ + âœ“ å‰ç¼€ | ç›´è§‰åŒ–"å·²å®Œæˆ"çŠ¶æ€ï¼Œæ— éšœç¢å‹å¥½ |
| æœªä¸Šèœè§†è§‰æ ·å¼ | æ­£å¸¸å¯¹æ¯”åº¦ + Â· å‰ç¼€ | ä¿æŒå½“å‰é£æ ¼ï¼Œçªå‡ºå¾…å¤„ç†é¡¹ |
| æ’åºè§„åˆ™ | æœªä¸Šèœåœ¨å‰ï¼Œå·²ä¸Šèœåœ¨å | æ“ä½œä¼˜å…ˆçº§ï¼šæœªå®Œæˆ > å·²å®Œæˆ |
| è¯¦æƒ…äº¤äº’ | å¼¹çª—ï¼ˆn-modalï¼‰ | PC/ç§»åŠ¨ç«¯ç»Ÿä¸€ï¼Œå®ç°ç®€å•ï¼Œä¸ç ´åå¡ç‰‡ç½‘æ ¼å¸ƒå±€ |

### æ•°æ®ç»“æ„å˜æ›´

**åç«¯ `TableSummary` æ‰©å±•**ï¼š

```typescript
// æ›¿æ¢ unserved_dishesï¼Œæ–°å¢ dishes å­—æ®µ
interface TableDishItem {
  name: string           // dish_name_snapshot
  qty_ordered: number    // æ€»ç‚¹æ•°
  qty_served: number     // å·²ä¸Šæ•°
  qty_unserved: number   // æœªä¸Šæ•° (qty_ordered - qty_served - qty_voided)
  unit_price_cents: number // å•ä»·ï¼ˆè¯¦æƒ…å¼¹çª—ç”¨ï¼‰
  status: 'unserved' | 'partial' | 'served'  // æ´¾ç”ŸçŠ¶æ€
}

interface TableSummary {
  // ...existing fields...
  dishes: TableDishItem[]       // å…¨éƒ¨èœå“ï¼ˆæ›¿æ¢ unserved_dishesï¼‰
  unserved_count: number        // æœªä¸Šèœæ€»é¡¹æ•°ï¼ˆç”¨äºçŠ¶æ€åˆ¤æ–­ï¼‰
}
```

## å®æ–½æ­¥éª¤

### Step 1ï¼šåç«¯ - æ–°å¢å…¨é‡èœå“æŸ¥è¯¢å‡½æ•°
- æ–‡ä»¶ï¼š`server/src/modules/tables/tables.repo.ts`
- æ“ä½œï¼šæ–°å¢ `loadAllDishesByTable()` å‡½æ•°ï¼ŒæŸ¥è¯¢æ‰€æœ‰èœå“ï¼ˆå«å·²ä¸Šèœï¼‰
- SQL é€»è¾‘ï¼šæŒ‰ `dish_name_snapshot` + `unit_sell_price_cents` åˆ†ç»„èšåˆ
- è¿”å›ï¼š`TableDishItem[]`ï¼ŒåŒ…å« qty_ordered/qty_served/qty_unserved/unit_price_cents/status
- é¢„æœŸäº§ç‰©ï¼šå¯æŸ¥è¯¢å…¨é‡èœå“çš„ repo å‡½æ•°

### Step 2ï¼šåç«¯ - æ›´æ–° TableSummary ç±»å‹å’Œç»„è£…é€»è¾‘
- æ–‡ä»¶ï¼š`server/src/modules/tables/tables.repo.ts`ã€`server/src/shared/types.ts`
- æ“ä½œï¼š
  - `TableSummary` ä¸­ `unserved_dishes` â†’ `dishes: TableDishItem[]` + `unserved_count: number`
  - `listTableSummaries()` ä½¿ç”¨æ–°çš„ `loadAllDishesByTable()` æ›¿æ¢ `loadUnservedByTable()`
  - `autoTransitionStuckSessions()` æ”¹ç”¨ `unserved_count` åˆ¤æ–­
- é¢„æœŸäº§ç‰©ï¼šAPI è¿”å›å…¨é‡èœå“æ•°æ®

### Step 3ï¼šå‰ç«¯ - æ›´æ–°ç±»å‹å®šä¹‰
- æ–‡ä»¶ï¼š`web/src/types/index.ts`
- æ“ä½œï¼šåŒæ­¥æ›´æ–° `TableSummary` å’Œæ–°å¢ `TableDishItem` ç±»å‹
- é¢„æœŸäº§ç‰©ï¼šå‰ç«¯ç±»å‹ä¸åç«¯å¯¹é½

### Step 4ï¼šå‰ç«¯ - é‡æ„ TableCard èœå“åˆ—è¡¨æ¸²æŸ“
- æ–‡ä»¶ï¼š`web/src/components/business/TableCard.vue`
- æ“ä½œï¼š
  - èœå“åˆ—è¡¨æ”¹ä¸ºæ¸²æŸ“ `table.dishes`ï¼ˆæ’åºï¼šæœªä¸Šèœåœ¨å‰ï¼‰
  - é¢„è§ˆé™åˆ¶ 3 é¡¹ï¼Œè¶…å‡ºæ˜¾ç¤º"æŸ¥çœ‹è¯¦æƒ… (å…±Né¡¹)"æŒ‰é’®
  - æœªä¸Šèœæ ·å¼ï¼š`Â· ç¾Šè‚‰ä¸²Ã—15`ï¼ˆæ­£å¸¸å¯¹æ¯”åº¦ï¼‰
  - å·²ä¸Šèœæ ·å¼ï¼š`âœ“ ç‰›è‚‰ä¸²Ã—5`ï¼ˆopacity-50 + line-throughï¼‰
  - éƒ¨åˆ†ä¸Šèœæ ·å¼ï¼š`Â· çƒ¤ç¿… 3/5æœªä¸Š`ï¼ˆé«˜äº®æœªä¸Šæ•°é‡ï¼‰
  - çŠ¶æ€åˆ¤æ–­é€»è¾‘ä» `unserved_dishes.length` æ”¹ä¸º `unserved_count`
- é¢„æœŸäº§ç‰©ï¼šå¡ç‰‡æ˜¾ç¤ºå…¨éƒ¨èœå“ï¼Œæœ‰çŠ¶æ€åŒºåˆ†

### Step 5ï¼šå‰ç«¯ - æ–°å¢èœå“è¯¦æƒ…å¼¹çª—
- æ–‡ä»¶ï¼š`web/src/components/business/TableCard.vue`ï¼ˆå†…è”å¼¹çª—ï¼‰
- æ“ä½œï¼š
  - ç‚¹å‡»"æŸ¥çœ‹è¯¦æƒ…"æ‰“å¼€ `n-modal`
  - å¼¹çª—å†…æ˜¾ç¤ºå®Œæ•´èœå“åˆ—è¡¨ + å•å“ä»·æ ¼ + çŠ¶æ€
  - æ ¼å¼ï¼š`èœå Ã—æ•°é‡  Â¥å•ä»·  çŠ¶æ€æ ‡ç­¾`
  - åº•éƒ¨æ˜¾ç¤ºæ€»è®¡é‡‘é¢
  - å¼¹çª—ç‚¹å‡»äº‹ä»¶éœ€ `@click.stop` é˜²æ­¢è§¦å‘å¡ç‰‡å¯¼èˆª
- é¢„æœŸäº§ç‰©ï¼šå¯æŸ¥çœ‹å…¨éƒ¨èœå“è¯¦æƒ…çš„å¼¹çª—

## å…³é”®æ–‡ä»¶

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `server/src/modules/tables/tables.repo.ts` | ä¿®æ”¹ | æ–°å¢å…¨é‡èœå“æŸ¥è¯¢ï¼Œæ›´æ–° Summary ç»„è£… |
| `web/src/types/index.ts` | ä¿®æ”¹ | æ›´æ–° TableSummary ç±»å‹ |
| `web/src/components/business/TableCard.vue` | ä¿®æ”¹ | é‡æ„èœå“åˆ—è¡¨ + æ–°å¢è¯¦æƒ…å¼¹çª— |

## é£é™©ä¸ç¼“è§£

| é£é™© | ç¼“è§£æªæ–½ |
|------|----------|
| å…¨é‡èœå“å¢åŠ  API å“åº”ä½“ç§¯ | çƒ§çƒ¤åº—å•æ¡Œèœå“é€šå¸¸ <30 é¡¹ï¼Œå½±å“å¯å¿½ç•¥ |
| åŒåèœå“ä¸åŒä»·æ ¼çš„èšåˆé—®é¢˜ | æŒ‰ name + price åˆ†ç»„ï¼Œé¿å…åˆå¹¶ä¸åŒä»·æ ¼ |
| autoTransitionStuckSessions é€»è¾‘å—å½±å“ | ä½¿ç”¨ç‹¬ç«‹çš„ unserved_count å­—æ®µåˆ¤æ–­ |
| å¡ç‰‡è§†è§‰å¯†åº¦å¢åŠ  | 3 é¡¹é¢„è§ˆé™åˆ¶ + è¯¦æƒ…å¼¹çª—åˆ†æµ |

## SESSION_IDï¼ˆä¾› /ccg:execute ä½¿ç”¨ï¼‰
- CODEX_SESSION: 019c6eb6-9a5b-7833-aef3-f88e31a8a815
- GEMINI_SESSION: 6f9c7734-259f-4abb-964b-d443fd397b2a
