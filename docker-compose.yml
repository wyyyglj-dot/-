services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${PORT:-3000}:${PORT:-3000}"
    environment:
      PORT: "${PORT:-3000}"
      DB_PATH: "${DB_PATH:-/app/data/diancan.db}"
      CORS_ORIGIN: "${CORS_ORIGIN:-*}"
      ADMIN_TOKEN: "${ADMIN_TOKEN:-}"
    volumes:
      - diancan-data:/app/data
    restart: unless-stopped
    init: true
    healthcheck:
      test: ["CMD-SHELL", "code=$$(curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1:$${PORT:-3000}/api/v1/auth/state || true); [ \"$$code\" = \"200\" ] || [ \"$$code\" = \"503\" ]"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s

volumes:
  diancan-data:
